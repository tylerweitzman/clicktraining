<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Click the Target Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-900 text-white flex items-center justify-center h-screen">

    <div id="game-area" class="relative w-full h-full overflow-hidden"></div>

    <div id="top-bar" class="absolute top-5 left-1/2 transform -translate-x-1/2 flex items-center space-x-10 text-xl">
        <div id="hit-counter">Hits: 0</div>
        <div id="time-counter">Time: 10</div>
    </div>

    <div id="result" class="hidden text-center text-2xl"></div>

    <div id="controls" class="flex flex-col items-center mt-10">
        <button id="restart-btn"
            class="mt-4 px-4 py-2 bg-blue-500 hover:bg-blue-700 text-white rounded">Restart</button>
        <input type="text" id="seed-input" value="2332" placeholder="Enter Seed"
            class="mt-4 px-4 py-2 text-black rounded">
        <input type="number" id="min-distance-input" placeholder="Min Distance (Optional)"
            class="mt-4 px-4 py-2 text-black rounded">
        <input type="number" id="max-distance-input" placeholder="Max Distance (Optional)"
            class="mt-4 px-4 py-2 text-black rounded">
    </div>

    <div id="pause-message"
        class="hidden fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-75 text-white text-2xl rounded p-8">
        Game Paused. Please return to fullscreen to resume.</div>

    <div id="stats"
        class="hidden fixed inset-0 flex flex-col items-center bg-gray-800 bg-opacity-75 text-white p-8 rounded">
        <div class="text-2xl mb-4">Game Stats</div>
        <div id="stats-content"></div>
        <canvas id="graph" class="mt-4 w-full"></canvas>
        <button id="name-submit-btn" class="mt-4 px-4 py-2 bg-blue-500 hover:bg-blue-700 text-white rounded">Submit to
            Leaderboard</button>
    </div>

    <!-- Name Input Modal -->
    <div id="name-modal"
        class="fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-75 text-white p-8 rounded">
        <div class="flex flex-col items-center">
            <label for="name-input" class="mb-2">Enter your full name:</label>
            <input type="text" id="name-input" class="px-4 py-2 text-black rounded mb-4" autocomplete="off">
            <button id="name-confirm-btn"
                class="px-4 py-2 bg-blue-500 hover:bg-blue-700 text-white rounded">Submit</button>
        </div>
    </div>

    <script>
        const apiKey = "$2a$10$gwxUJBrS5PQ6Phevd/wnJOEDDXPm.ThptKKA.p7l.tox15Kh0dTmq";
        const binId = "66c3465be41b4d34e4226708";
        let score = 0, timeLeft = 10, seed = 2332, gameSpeed = 1000;
        let gamePaused = false, hitData = [], minDistance, maxDistance;
        const gameArea = document.getElementById('game-area'), hitCounter = document.getElementById('hit-counter');
        const timeCounter = document.getElementById('time-counter'), result = document.getElementById('result');
        const restartBtn = document.getElementById('restart-btn'), seedInput = document.getElementById('seed-input');
        const minDistanceInput = document.getElementById('min-distance-input'), maxDistanceInput = document.getElementById('max-distance-input');
        const pauseMessage = document.getElementById('pause-message'), stats = document.getElementById('stats');
        const statsContent = document.getElementById('stats-content'), nameModal = document.getElementById('name-modal');
        const nameInput = document.getElementById('name-input'), nameConfirmBtn = document.getElementById('name-confirm-btn');
        const nameSubmitBtn = document.getElementById('name-submit-btn');
        let timeInterval, currentTarget, startTime, playerName = "";

        const random = seed => Math.sin(seed++) * 10000 % 1;

        const getRandomPosition = seed => {
            let x, y, distance;
            do {
                x = random(seed) * (window.innerWidth - 30);
                y = random(seed + 1) * (window.innerHeight - 30);
                distance = currentTarget ? Math.hypot(x - currentTarget.x, y - currentTarget.y) : 0;
            } while ((minDistance && distance < minDistance) || (maxDistance && distance > maxDistance));
            return { x, y };
        };

        const createTarget = () => {
            if (currentTarget) {
                gameArea.removeChild(currentTarget.element);
            }
            seed += 2; // Increment seed to ensure different positions for each target
            const target = document.createElement('div');
            const { x, y } = getRandomPosition(seed);
            target.className = 'target absolute bg-red-500 rounded-full cursor-pointer';
            target.style.width = '15px';
            target.style.height = '15px';
            target.style.left = `${x}px`;
            target.style.top = `${y}px`;
            target.addEventListener('click', () => recordHit(x, y));
            gameArea.appendChild(target);
            currentTarget = { x, y, element: target };
            startTime = performance.now();
        };

        const recordHit = (x, y, seed) => {
            const endTime = performance.now(), timeTaken = endTime - startTime;
            const distance = Math.hypot(currentTarget.x - x, currentTarget.y - y);
            hitData.push({ time: timeTaken, distance });
            score++;
            hitCounter.textContent = `Hits: ${score}`;
            createTarget(seed + 2);
        };

        const playSound = type => new Audio(`${type}.wav`).play();

        const startGame = () => {
            if (!document.fullscreenElement) requestFullscreen();
            resetGame();
            timeInterval = setInterval(() => updateTime(), gameSpeed);
            createTarget(seed);
        };

        const updateTime = () => {
            if (--timeLeft <= 0) endGame();
            timeCounter.textContent = `Time: ${timeLeft}`;
        };

        const resetGame = () => {
            score = 0;
            timeLeft = 10;
            gameSpeed = 1000;
            hitData = [];
            minDistance = +minDistanceInput.value || 0;
            maxDistance = +maxDistanceInput.value || Infinity;
            clearInterval(timeInterval);
            result.classList.add('hidden');
            stats.classList.add('hidden');
        };

        const endGame = () => {
            clearInterval(timeInterval);
            gameArea.innerHTML = '';
            timeCounter.classList.add('hidden');
            result.classList.remove('hidden');
            result.textContent = `You clicked ${score} targets!`;
            restartBtn.classList.remove('hidden');
            seedInput.classList.remove('hidden');
            minDistanceInput.classList.remove('hidden');
            maxDistanceInput.classList.remove('hidden');
            showStats();
            nameModal.classList.remove('hidden');
        };

        const showStats = () => {
                const totalTargets = hitData.length, totalTime = hitData.reduce((acc, { time }) => acc + time, 0);
                const avgRate = (totalTime / totalTargets).toFixed(2), fastestHit = Math.min(...hitData.map(({ time }) => time)).toFixed(2);
                const slowestHit = Math.max(...hitData.map(({ time }) => time)).toFixed(2), avgDistance = (hitData.reduce((acc, { distance }) => acc + distance, 0) / totalTargets).toFixed(2);
                const targetsPerMinute = (60000 / avgRate).toFixed(2), fastestTPM = (60000 / fastestHit).toFixed(2), slowestTPM = (60000 / slowestHit).toFixed(2);

                statsContent.innerHTML = `
        <p>Targets Hit: ${totalTargets} targets in ${timeLeft} seconds</p>
        <p>Game Area: ${window.innerWidth}px x ${window.innerHeight}px</p>
        <p>Avg. Rate: ${avgRate}ms per target for ${avgDistance}px distance | ${targetsPerMinute} TPM</p>
        <p>Fastest Hit: ${fastestHit}ms | ${fastestTPM} TPM</p>
        <p>Slowest Hit: ${slowestHit}ms | ${slowestTPM} TPM</p>
        <table>
            <tr><th>#</th><th>Speed</th><th>Distance</th></tr>
            ${hitData.map((data, i) => `<tr><td>${i + 1}</td><td>${data.time.toFixed(2)}ms</td><td>${data.distance.toFixed(2)}px</td></tr>`).join('')}
        </table>
    `;
                generateGraph();
            };
            const generateGraph = () => {
                    const ctx = document.getElementById('graph').getContext('2d');
                    const labels = hitData.map((_, i) => i + 1);
                    const data = {
                        labels,
                        datasets: [{
                            label: 'Hit Time (ms)',
                            data: hitData.map(data => data.time),
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            fill: false,
                        }]
                    };
                    new Chart(ctx, { type: 'line', data });
                };

                const requestFullscreen = () => document.documentElement.requestFullscreen();

                const submitToLeaderboard = async () => {
                    const leaderboardEntry = {
                        name: playerName,
                        score,
                        seed,
                        resolution: `${window.innerWidth}x${window.innerHeight}`,
                        minDistance: minDistance || "Not Set",
                        maxDistance: maxDistance !== Infinity ? maxDistance : "Not Set"
                    };
                    try {
                        const response = await fetch(`https://api.jsonbin.io/v3/b/${binId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Master-Key': apiKey
                            },
                            body: JSON.stringify(leaderboardEntry)
                        });
                        if (!response.ok) throw new Error('Failed to save');
                    } catch (error) {
                        console.error("Error saving to leaderboard:", error);
                    }
                };

                nameConfirmBtn.addEventListener('click', () => {
                    playerName = nameInput.value;
                    if (playerName.trim()) {
                        nameModal.classList.add('hidden');
                    }
                });

                nameSubmitBtn.addEventListener('click', () => {
                    if (playerName.trim()) {
                        submitToLeaderboard();
                        stats.classList.add('hidden');
                    }
                });

                restartBtn.addEventListener('click', () => {
                    seed = parseInt(seedInput.value, 10);
                    startGame();
                });

                document.addEventListener('fullscreenchange', () => {
                    if (!document.fullscreenElement) pauseGame();
                    else resumeGame();
                });

                const pauseGame = () => {
                    clearInterval(timeInterval);
                    gamePaused = true;
                    pauseMessage.classList.remove('hidden');
                };

                const resumeGame = () => {
                    gamePaused = false;
                    pauseMessage.classList.add('hidden');
                    timeInterval = setInterval(updateTime, gameSpeed);
                };

                endGame();  // Initial state is the end screen
            </script>
            </body>
            </html>